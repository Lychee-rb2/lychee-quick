# i18n 国际化完整规划

## 现状分析

- i18n 基础设施已就绪：`i18n/index.ts` 提供 `t()` 函数，支持嵌套 key、变量插值、类型安全
- 翻译文件仅有 1 条记录：`i18n/zh.json` / `i18n/en.json`
- `t()` 函数未在任何业务代码中使用
- 项目中约 **80+ 处**硬编码字符串需要国际化

## 翻译 Key 命名规范

采用**命名空间 + 语义化**的嵌套结构，与文件目录对应：

```json
{
  "app": {
    "completion": "...",
    "help": "...",
    "clash": {
      "completion": "...",
      "help": "...",
      "board": { "completion": "...", "openWait": "..." },
      "check": { "completion": "...", "noProxy": "...", "unknownError": "..." },
      "toggle": { "completion": "...", "modeChanged": "..." }
    }
  },
  "prompt": {
    "mihomo": { "refresh": "...", "reset": "...", "pickProxy": "..." },
    "linear": { "sendPreviewLink": "...", "checkoutBranch": "..." },
    "vercel": { "checkPr": "...", "releaseProject": "..." }
  },
  "error": {
    "mihomo": { "timeout": "...", "unavailable": "...", "notFound": "...", "requestFailed": "...", "networkError": "..." },
    "env": { "missingVar": "..." }
  },
  "cli": {
    "usage": "...",
    "availableCommands": "...",
    "runHelp": "...",
    "cannotFind": "..."
  },
  "script": {
    "installCli": { "binUpdated": "...", "installed": "..." },
    "zshCompletion": { "alreadyConfigured": "...", "installed": "..." }
  }
}
```

## 需要国际化的文件清单

### Phase 1: meta.ts 帮助文本（高优先级，12 个文件）

所有 `meta.ts` 文件的 `completion` 和 `help` 导出目前是纯中文硬编码。需要改为使用 `t()` 函数。

涉及文件：

- `app/meta.ts` — 根命令帮助
- `app/clash/meta.ts`
- `app/clash/board/meta.ts`
- `app/clash/check/meta.ts`
- `app/clash/toggle/meta.ts`
- `app/linear/meta.ts`
- `app/linear/branch/meta.ts`
- `app/linear/preview/meta.ts`
- `app/linear/release/meta.ts`
- `app/vercel/meta.ts`
- `app/vercel/check/meta.ts`
- `app/vercel/release/meta.ts`

**改造方式**：将静态字符串导出改为函数调用或 getter，使 `t()` 在运行时求值：

```typescript
// BEFORE (app/clash/meta.ts)
export const completion = "Mihomo/Clash 代理管理";

// AFTER
import { t } from "@/i18n";
export const completion = () => t("app.clash.completion");
export const help = () => t("app.clash.help");
```

> 注意：meta.ts 的消费方 `help/io.ts` 需要同步修改，将 `meta.completion` 改为 `meta.completion()` 函数调用。

### Phase 2: handler 日志/错误消息（高优先级，4 个文件）

- `app/clash/board/handler.ts` — 英文日志 `"Opening ${url}, wait global delay test"`
- `app/clash/check/handler.ts` — 混合：`"No proxy found"` + `"未知错误: ..."`
- `app/clash/toggle/handler.ts` — 英文日志 `"Mode changed to ..."`
- `app/vercel/check/handler.ts` — 英文日志 `"Branch: ..."`

### Phase 3: 交互提示（高优先级，3 个文件）

- `prompts/mihomo.ts` — `"Refresh"`, `"Reset"`, `"Pick a proxy"`, `"To which mode?"` 等
- `prompts/linear.ts` — `"Send which preview link?"`, `"Checkout branch from which issue?"` 等
- `prompts/vercel.ts` — `"Check which pull request?"`, `"Release which project?"` 等

### Phase 4: fetch 错误消息（中优先级，1 个文件）

- `fetch/mihomo.ts` — 5 条中文错误消息：`"请求超时"`, `"服务不可用"`, `"资源未找到"`, `"请求失败"`, `"网络请求失败"`

### Phase 5: CLI 框架消息（中优先级，2 个文件）

- `help/io.ts` — `"Usage: ..."`, `"Available commands:"`, `"Can't find action ..."`, 缩写匹配错误等
- `help/env.ts` — `"Missing required environment variable: ..."`

### Phase 6: 脚本消息（低优先级，4 个文件）

- `scripts/utils/installCli.ts` — 安装成功/失败消息
- `scripts/utils/installZshCompletion.ts` — zsh 补全安装消息
- `scripts/utils/buildGlobalEnv.ts` — 代码生成消息
- `scripts/utils/getCompletions.ts` — 错误消息

### Phase 7: 其他

- `help/linear.ts` — `"# Release note: ${today}"`（可能不需要国际化，视需求）

## 实施注意事项

### 1. meta.ts 改造的 breaking change

当前 `meta.ts` 导出的是**静态字符串**，`help/io.ts` 直接读取 `meta.completion`。改为 `t()` 后有两种方案：

- **方案 A**：将 `completion`/`help` 改为函数，修改 `help/io.ts` 的消费方式
- **方案 B**：保持字符串导出，但在 `meta.ts` 顶层调用 `t()`（需确保 i18n 在模块加载时已初始化）

推荐**方案 A**，更明确且避免模块加载顺序问题。

### 2. 变量插值统一

- 中文模板字符串如 `"未知错误: ${String(error)}"` 改为 `t("error.clash.unknown", { error: String(error) })`
- 保持现有的 `{varName}` 插值语法

### 3. 注释不需要国际化

代码注释（如 `help/logger.ts` 中的中文注释）不需要纳入 i18n，保持原样。

### 4. 测试同步更新

修改后需要更新相关测试文件中的断言，确保测试基于 `t()` 返回值或 mock i18n。

### 5. 翻译文件预估体量

- `zh.json`：预计约 80-100 个 key
- `en.json`：预计约 80-100 个 key
- 建议保持 JSON 平铺到 2-3 层嵌套，不宜过深
