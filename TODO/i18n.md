# i18n 国际化完整规划

## 现状分析

- i18n 基础设施已就绪：`i18n/index.ts` 提供 `t()` 函数，支持嵌套 key、变量插值、类型安全
- ~~翻译文件仅有 1 条记录~~ → 翻译文件已包含所有 meta.ts 帮助文本（约 24 个 key）
- ~~`t()` 函数未在任何业务代码中使用~~ → 12 个 meta.ts 文件已改用 `t()` 函数
- 项目中约 **60+ 处**硬编码字符串仍需国际化（Phase 2-7）

## 翻译 Key 命名规范

采用**命名空间 + 语义化**的嵌套结构，与文件目录对应：

```json
{
  "app": {
    "completion": "...",
    "help": "...",
    "clash": {
      "completion": "...",
      "help": "...",
      "board": { "completion": "...", "openWait": "..." },
      "check": { "completion": "...", "noProxy": "...", "unknownError": "..." },
      "toggle": { "completion": "...", "modeChanged": "..." }
    }
  },
  "prompt": {
    "mihomo": { "refresh": "...", "reset": "...", "pickProxy": "..." },
    "linear": { "sendPreviewLink": "...", "checkoutBranch": "..." },
    "vercel": { "checkPr": "...", "releaseProject": "..." }
  },
  "error": {
    "mihomo": { "timeout": "...", "unavailable": "...", "notFound": "...", "requestFailed": "...", "networkError": "..." },
    "env": { "missingVar": "..." }
  },
  "cli": {
    "usage": "...",
    "availableCommands": "...",
    "runHelp": "...",
    "cannotFind": "..."
  },
  "script": {
    "installCli": { "binUpdated": "...", "installed": "..." },
    "zshCompletion": { "alreadyConfigured": "...", "installed": "..." }
  }
}
```

## 需要国际化的文件清单

### Phase 1: meta.ts 帮助文本（高优先级，12 个文件）✅ 已完成

所有 `meta.ts` 文件的 `completion` 和 `help` 导出已改为使用 `t()` 函数（方案 A）。

已完成的改动：

- ✅ 12 个 `meta.ts` 文件：导出从静态字符串改为函数 `() => t("key")`
- ✅ `i18n/zh.json` / `i18n/en.json`：新增 `app.*` 命名空间下约 24 个翻译 key
- ✅ `types/io.ts`：`ModuleLoader.loadMeta` 返回类型改为 `string | (() => string)`
- ✅ `help/io.ts`：新增 `resolveMeta()` 辅助函数，兼容字符串和函数两种形式
- ✅ `scripts/utils/getCompletions.ts`：支持 `completion` 为函数的情况
- ✅ `test/help/io.test.ts` / `test/scripts/getCompletions.test.ts`：mock 同步更新
- ✅ 全部 439 个测试通过，0 个 lint 错误

### Phase 2: handler 日志/错误消息（高优先级，4 个文件）✅ 已完成

4 个 handler 文件的日志/错误消息已改为使用 `t()` 函数。

已完成的改动：

- ✅ `app/clash/board/handler.ts`：`"Opening ${url}, wait global delay test"` → `t("app.clash.board.openWait", { url })`
- ✅ `app/clash/check/handler.ts`：`"No proxy found"` → `t("app.clash.check.noProxy")`，`"未知错误: ..."` → `t("app.clash.check.unknownError", { error })`
- ✅ `app/clash/toggle/handler.ts`：`"Mode changed to ..."` → `t("app.clash.toggle.modeChanged", { mode })`
- ✅ `app/vercel/check/handler.ts`：`"Branch: ..."` → `t("app.vercel.check.branch", { branch })`
- ✅ `i18n/zh.json` / `i18n/en.json`：新增 5 个翻译 key（`openWait`、`noProxy`、`unknownError`、`modeChanged`、`branch`），移除旧 key `"wait mihomo delay to open board"`
- ✅ 4 个测试文件同步更新：mock `@/i18n` 的 `t()` 函数，验证 key 和参数传递
- ✅ 全部 439 个测试通过，0 个 lint 错误

### Phase 3: 交互提示（高优先级，3 个文件）✅ 已完成

3 个 prompt 文件的交互提示消息已改为使用 `t()` 函数。

已完成的改动：

- ✅ `prompts/mihomo.ts`：`"Refresh"` → `t("prompt.mihomo.refresh")`，`"Reset"` → `t("prompt.mihomo.reset")`，`"Pick a proxy ..."` → `t("prompt.mihomo.pickProxy", { name })`，`"To which mode?"` → `t("prompt.mihomo.toWhichMode")`
- ✅ `prompts/linear.ts`：5 条提示消息改为 `t("prompt.linear.*")`（`sendPreviewLink`、`confirmSendComment`、`checkoutBranch`、`sendPreviewComment`、`releaseIssue`）
- ✅ `prompts/vercel.ts`：`"Check which pull request?"` → `t("prompt.vercel.checkPr")`，`"Release which project?"` → `t("prompt.vercel.releaseProject")`
- ✅ `i18n/zh.json` / `i18n/en.json`：新增 `prompt.*` 命名空间下 11 个翻译 key
- ✅ 3 个测试文件同步更新：mock `@/i18n` 的 `t()` 函数，验证 key 传递
- ✅ 全部 439 个测试通过，0 个 lint 错误

### Phase 4: fetch 错误消息（中优先级，1 个文件）✅ 已完成

`fetch/mihomo.ts` 的 5 条中文错误消息已改为使用 `t()` 函数。

已完成的改动：

- ✅ `fetch/mihomo.ts`：`"请求超时"` → `t("error.mihomo.timeout")`，`"服务不可用"` → `t("error.mihomo.unavailable")`，`"资源未找到"` → `t("error.mihomo.notFound")`，`"请求失败"` → `t("error.mihomo.requestFailed")`，`"网络请求失败"` → `t("error.mihomo.networkError")`
- ✅ `i18n/zh.json` / `i18n/en.json`：新增 `error.mihomo.*` 命名空间下 5 个翻译 key
- ✅ `test/fetch/mihomo.test.ts` 同步更新：mock `@/i18n`，21 个测试通过
- ✅ 全部 439 个测试通过，0 个 lint 错误

### Phase 5: CLI 框架消息（中优先级，2 个文件）✅ 已完成

- ✅ `help/io.ts` — 导入 `t`，替换 10 处硬编码字符串为 `t()` 调用：
  - `cli.usage` — Usage 信息
  - `cli.availableCommands` — 可用命令标题
  - `cli.runHelp` — 运行帮助提示
  - `cli.subcommandUsage` — 子命令 Usage
  - `cli.availableSubcommands` — 可用子命令标题
  - `cli.cannotFindHelp` — 找不到帮助信息
  - `cli.noHelpAvailable` — 无可用帮助
  - `cli.cannotFind` — 找不到命令
  - `cli.metaError` — meta.ts 读取错误
  - `cli.aliasMultipleMatches` — 缩写匹配多个命令
- ✅ `help/env.ts` — 导入 `t`，替换 Zod 错误消息为 `t("error.env.missingVar", { name })`
- ✅ `i18n/zh.json` 新增 `cli.*` (10 个键) 和 `error.env.missingVar`
- ✅ `i18n/en.json` 新增 `cli.*` (10 个键) 和 `error.env.missingVar`
- ✅ `test/help/io.test.ts` 同步更新：mock `@/i18n`，更新断言为 i18n key 检查，39 个测试通过
- ✅ `test/help/env.test.ts` 同步更新：mock `@/i18n`，40 个测试通过
- ✅ 全部 439 个测试通过，0 个 lint 错误

### Phase 6: 脚本消息（低优先级，4 个文件）

- `scripts/utils/installCli.ts` — 安装成功/失败消息
- `scripts/utils/installZshCompletion.ts` — zsh 补全安装消息
- `scripts/utils/buildGlobalEnv.ts` — 代码生成消息
- `scripts/utils/getCompletions.ts` — 错误消息

### Phase 7: 其他

- `help/linear.ts` — `"# Release note: ${today}"`（可能不需要国际化，视需求）

## 实施注意事项

### 1. meta.ts 改造的 breaking change ✅ 已解决

已采用**方案 A**：`completion`/`help` 改为函数导出，消费方通过 `resolveMeta()` 统一处理字符串和函数两种形式，保持向后兼容。

### 2. 变量插值统一

- 中文模板字符串如 `"未知错误: ${String(error)}"` 改为 `t("error.clash.unknown", { error: String(error) })`
- 保持现有的 `{varName}` 插值语法

### 3. 注释不需要国际化

代码注释（如 `help/logger.ts` 中的中文注释）不需要纳入 i18n，保持原样。

### 4. 测试同步更新

修改后需要更新相关测试文件中的断言，确保测试基于 `t()` 返回值或 mock i18n。

### 5. 翻译文件预估体量

- `zh.json`：预计约 80-100 个 key
- `en.json`：预计约 80-100 个 key
- 建议保持 JSON 平铺到 2-3 层嵌套，不宜过深
